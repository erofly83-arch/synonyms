<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–†–µ–¥–∞–∫—Ç–æ—Ä —Å–∏–Ω–æ–Ω–∏–º–æ–≤ —à—Ç—Ä–∏—Ö–∫–æ–¥–æ–≤</title>
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext x='50%25' y='50%25' dominant-baseline='central' text-anchor='middle' font-size='80'%3Eüîó%3C/text%3E%3C/svg%3E" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/exceljs@4.3.0/dist/exceljs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * { margin:0; padding:0; box-sizing:border-box; }
        body { font-family:-apple-system,BlinkMacSystemFont,'SF Pro Display','Segoe UI',Arial,sans-serif; background:#f2f2f7; padding:16px; color:#1c1c1e; }
        .container { max-width:1400px; margin:0 auto; background:white; border-radius:16px; padding:24px; box-shadow:0 4px 16px rgba(0,0,0,0.08); }
        h1 { font-size:28px; font-weight:600; margin-bottom:20px; color:#1c1c1e; letter-spacing:-0.5px; }
        .upload-section { display:grid; grid-template-columns:1fr; gap:12px; margin-bottom:12px; }
        .upload-card { background:#fff9e6; border-radius:12px; padding:12px; border:2px dashed #ffcc00; transition:all 0.2s; }
        .upload-card:hover { border-color:#ff9500; }
        .upload-label { display:block; font-size:12px; font-weight:600; color:#ff9500; margin-bottom:6px; text-transform:uppercase; letter-spacing:0.5px; }
        .file-input-wrapper { position:relative; }
        .file-input-wrapper input[type="file"] { position:absolute; opacity:0; width:100%; height:100%; cursor:pointer; }
        .file-input-display { display:flex; align-items:center; gap:6px; padding:8px 10px; background:white; border-radius:8px; font-size:13px; color:#ff9500; font-weight:500; cursor:pointer; transition:all 0.2s; }
        .file-input-display:hover { background:#fff3e0; }
        .search-box { margin-bottom:12px; }
        .search-input { width:100%; padding:10px 12px; border:2px solid #e5e5ea; border-radius:10px; font-size:14px; font-family:inherit; transition:all 0.2s; }
        .search-input:focus { outline:none; border-color:#007aff; background:#f0f7ff; }
        .controls { display:flex; gap:6px; margin-bottom:8px; flex-wrap:wrap; }
        .btn { padding:6px 10px; border:none; border-radius:8px; cursor:pointer; font-weight:600; font-size:12px; transition:all 0.2s; display:flex; align-items:center; gap:4px; line-height:1; white-space:nowrap; }
        .btn span.icon { font-size:14px; }
        .btn-primary { background:#007aff; color:white; }
        .btn-primary:hover { background:#0051d5; transform:translateY(-1px); box-shadow:0 3px 8px rgba(0,122,255,0.25); }
        .btn-success { background:#34c759; color:white; }
        .btn-success:hover { background:#28a745; transform:translateY(-1px); box-shadow:0 3px 8px rgba(52,199,89,0.25); }
        .btn-warning { background:#ff9500; color:white; }
        .btn-warning:hover { background:#e08600; transform:translateY(-1px); box-shadow:0 3px 8px rgba(255,149,0,0.25); }
        .btn-danger { background:#ff3b30; color:white; }
        .btn-danger:hover { background:#d70015; }
        .btn-secondary { background:#f9f9fb; color:#007aff; border:1px solid #e5e5ea; }
        .btn-secondary:hover { background:#e8f4ff; }
        .btn-secondary.active { background:#007aff; color:white; }
        .btn:disabled { background:#e5e5ea; color:#aeaeb2; cursor:not-allowed; transform:none; }
        .info-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(160px,1fr)); gap:10px; margin-bottom:12px; }
        .info-card { background:linear-gradient(135deg,#667eea 0%,#764ba2 100%); border-radius:12px; padding:10px; color:white; }
        .info-card:nth-child(2){background:linear-gradient(135deg,#f093fb 0%,#f5576c 100%);}
        .info-card:nth-child(3){background:linear-gradient(135deg,#4facfe 0%,#00f2fe 100%);}
        .info-card:nth-child(4){background:linear-gradient(135deg,#ff9500 0%,#ff5e62 100%);}
        .info-value { font-size:22px; font-weight:700; margin-bottom:2px; letter-spacing:-0.5px; }
        .info-label { font-size:11px; opacity:0.9; font-weight:500; }
        .groups-container { display:grid; gap:12px; margin-bottom:12px; }
        .group-card { background:#f9f9fb; border-radius:12px; padding:12px; border:2px solid #e5e5ea; transition:all 0.2s; }
        .group-card:hover { border-color:#c7c7cc; }
        .group-card.has-conflict { border-color:#ff3b30; background:#fff5f5; }
        .group-header { display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:8px; gap:8px; }
        .group-main-info { flex:1; min-width:0; }
        .group-barcode { font-size:16px; font-weight:700; color:#1c1c1e; margin-bottom:4px; font-family:'Courier New',monospace; }
        .group-name { font-size:13px; color:#8e8e93; margin-bottom:6px; }
        .group-name input { width:100%; padding:4px 8px; border:1px solid #e5e5ea; border-radius:6px; font-size:13px; font-family:inherit; }
        .group-name input:focus { outline:none; border-color:#007aff; }
        .group-actions { display:flex; gap:4px; }
        .group-btn { padding:4px 8px; border:none; border-radius:6px; cursor:pointer; font-size:11px; font-weight:600; transition:all 0.2s; }
        .group-btn-delete { background:#ff3b30; color:white; }
        .group-btn-delete:hover { background:#d70015; }
        .synonyms-list { display:flex; flex-wrap:wrap; gap:6px; margin-bottom:8px; }
        .synonym-tag { display:flex; align-items:center; gap:4px; padding:4px 8px; background:#e8f4ff; border:1px solid #c7ddff; border-radius:6px; font-size:12px; font-family:'Courier New',monospace; }
        .synonym-tag.conflict { background:#ffe6e6; border-color:#ff3b30; }
        .synonym-remove { border:none; background:none; color:#ff3b30; cursor:pointer; font-size:14px; line-height:1; padding:0; margin-left:2px; }
        .synonym-remove:hover { color:#d70015; }
        .add-synonym { display:flex; gap:4px; }
        .add-synonym input { flex:1; padding:4px 8px; border:1px solid #e5e5ea; border-radius:6px; font-size:12px; font-family:'Courier New',monospace; }
        .add-synonym input:focus { outline:none; border-color:#007aff; }
        .add-synonym button { padding:4px 12px; border:none; border-radius:6px; background:#34c759; color:white; font-size:12px; font-weight:600; cursor:pointer; }
        .add-synonym button:hover { background:#28a745; }
        .conflict-warning { background:#ffe6e6; color:#ff3b30; padding:4px 8px; border-radius:6px; font-size:11px; font-weight:600; margin-top:4px; }
        .add-group-section { background:#f0fdf4; border-radius:12px; padding:12px; border:2px dashed #34c759; margin-bottom:12px; }
        .add-group-title { font-size:13px; font-weight:600; color:#34c759; margin-bottom:8px; }
        .add-group-form { display:grid; gap:8px; }
        .add-group-form input { padding:8px 10px; border:1px solid #e5e5ea; border-radius:8px; font-size:13px; font-family:inherit; }
        .add-group-form input:focus { outline:none; border-color:#34c759; }
        .add-group-form textarea { padding:8px 10px; border:1px solid #e5e5ea; border-radius:8px; font-size:12px; font-family:'Courier New',monospace; resize:vertical; min-height:60px; }
        .add-group-form textarea:focus { outline:none; border-color:#34c759; }
        .instructions-panel { display:none; margin-bottom:10px; padding:10px 12px; background:#f0f7ff; border-radius:10px; border:1px solid #c7ddff; font-size:12px; color:#1c1c1e; }
        .instructions-panel h3 { font-size:13px; margin-bottom:4px; }
        .instructions-panel ul { margin-left:16px; margin-bottom:6px; }
        .instructions-panel li { margin-bottom:2px; }
        .instructions-highlight { background:#e6f0ff; padding:4px 6px; border-radius:6px; margin-bottom:6px; }
        .empty-state { text-align:center; padding:40px 20px; color:#8e8e93; }
        .empty-state-icon { font-size:48px; margin-bottom:12px; }
        .empty-state h3 { font-size:18px; font-weight:600; margin-bottom:6px; color:#1c1c1e; }
        .empty-state p { font-size:13px; }
        @media (max-width:768px){.info-grid{grid-template-columns:repeat(2,1fr);}}
    </style>
</head>
<body>
<div class="container">
    <h1>üîó –†–µ–¥–∞–∫—Ç–æ—Ä —Å–∏–Ω–æ–Ω–∏–º–æ–≤ —à—Ç—Ä–∏—Ö–∫–æ–¥–æ–≤</h1>

    <div class="upload-section">
        <div class="upload-card">
            <label class="upload-label">üß© –§–∞–π–ª —Å–∏–Ω–æ–Ω–∏–º–æ–≤ (JSON)</label>
            <div class="file-input-wrapper">
                <input type="file" id="fileInput" accept=".json"/>
                <div class="file-input-display" title="–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª synonyms.json">
                    <span>üìÑ –í—ã–±—Ä–∞—Ç—å synonyms.json</span>
                </div>
            </div>
            <div id="fileStatus" style="margin-top:6px;font-size:11px;color:#8e8e93;">
                –§–∞–π–ª –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω
            </div>
        </div>
    </div>

    <div class="search-box">
        <input type="text" id="searchInput" class="search-input"
               placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ —à—Ç—Ä–∏—Ö–∫–æ–¥—É –∏–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏—é..."
               title="–í–≤–µ–¥–∏—Ç–µ —à—Ç—Ä–∏—Ö–∫–æ–¥ –∏–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –≥—Ä—É–ø–ø" disabled>
    </div>

    <div class="controls">
        <button id="addGroupBtn" class="btn btn-primary" disabled
                title="–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é –≥—Ä—É–ø–ø—É —Å–∏–Ω–æ–Ω–∏–º–æ–≤">
            <span class="icon">‚ûï</span> –î–æ–±–∞–≤–∏—Ç—å –≥—Ä—É–ø–ø—É
        </button>
        <button id="checkConflictsBtn" class="btn btn-secondary" disabled
                title="–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥—É–±–ª–∏–∫–∞—Ç—ã —à—Ç—Ä–∏—Ö–∫–æ–¥–æ–≤ –≤ —Ä–∞–∑–Ω—ã—Ö –≥—Ä—É–ø–ø–∞—Ö">
            <span class="icon">üîç</span> –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã
        </button>
        <button id="sortByNameBtn" class="btn btn-secondary" disabled
                title="–û—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –≥—Ä—É–ø–ø—ã –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é —Ç–æ–≤–∞—Ä–∞">
            <span class="icon">üî§</span> –ü–æ –∏–º–µ–Ω–∏
        </button>
        <button id="toggleInstructionsBtn" class="btn btn-secondary"
                title="–ü–æ–∫–∞–∑–∞—Ç—å –∏–ª–∏ —Å–∫—Ä—ã—Ç—å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏">
            <span class="icon">‚ùì</span> –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏
        </button>
        <button id="exportJsonBtn" class="btn btn-success" disabled
                title="–°–∫–∞—á–∞—Ç—å –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π JSON —Ñ–∞–π–ª">
            <span class="icon">üíæ</span> –°–∫–∞—á–∞—Ç—å JSON
        </button>
        <button id="exportExcelBtn" class="btn btn-success" disabled
                title="–°–∫–∞—á–∞—Ç—å Excel –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞">
            <span class="icon">üìä</span> –°–∫–∞—á–∞—Ç—å Excel
        </button>
        <button id="importExcelBtn" class="btn btn-warning" disabled
                title="–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ Excel (–≥–ª–∞–≤–Ω—ã–π –®–ö, –Ω–∞–∑–≤–∞–Ω–∏–µ, —Å–∏–Ω–æ–Ω–∏–º—ã)">
            <span class="icon">üì•</span> –ò–º–ø–æ—Ä—Ç –∏–∑ Excel
        </button>
        <button id="clearBtn" class="btn btn-danger" disabled
                title="–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –∏ –Ω–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ">
            <span class="icon">üóëÔ∏è</span> –û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë
        </button>
    </div>

    <input type="file" id="excelImportInput" accept=".xlsx,.xls" style="display:none;" />

    <div id="instructionsPanel" class="instructions-panel">
        <div class="instructions-highlight">
            –†–µ–¥–∞–∫—Ç–æ—Ä —É–ø—Ä–∞–≤–ª—è–µ—Ç –≥—Ä—É–ø–ø–∞–º–∏ —Å–∏–Ω–æ–Ω–∏–º–æ–≤ —à—Ç—Ä–∏—Ö–∫–æ–¥–æ–≤. –ü–µ—Ä–≤—ã–π —ç–ª–µ–º–µ–Ω—Ç ‚Äî –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞, –∑–∞—Ç–µ–º –≥–ª–∞–≤–Ω—ã–π —à—Ç—Ä–∏—Ö–∫–æ–¥ –∏ –µ–≥–æ —Å–∏–Ω–æ–Ω–∏–º—ã.
        </div>

        <h3>1. –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞</h3>
        <ul>
            <li>–ó–∞–≥—Ä—É–∑–∏—Ç–µ JSON —Ñ–∞–π–ª —Å —Å–∏–Ω–æ–Ω–∏–º–∞–º–∏ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.</li>
            <li>–§–æ—Ä–º–∞—Ç: <code>{ "–≥–ª–∞–≤–Ω—ã–π–®–ö": ["–ù–∞–∑–≤–∞–Ω–∏–µ", "—Å–∏–Ω–æ–Ω–∏–º1", ...] }</code></li>
        </ul>

        <h3>2. –†–∞–±–æ—Ç–∞ —Å –≥—Ä—É–ø–ø–∞–º–∏</h3>
        <ul>
            <li>–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç—Å—è –ø—Ä—è–º–æ –≤ –ø–æ–ª–µ.</li>
            <li>–°–∏–Ω–æ–Ω–∏–º—ã –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è —á–µ—Ä–µ–∑ –ø–æ–ª–µ ¬´–î–æ–±–∞–≤–∏—Ç—å —Å–∏–Ω–æ–Ω–∏–º¬ª –∏ —É–¥–∞–ª—è—é—Ç—Å—è –∫–Ω–æ–ø–∫–æ–π ‚úï.</li>
            <li>–ì—Ä—É–ø–ø–∞ —É–¥–∞–ª—è–µ—Ç—Å—è –∫–Ω–æ–ø–∫–æ–π üóëÔ∏è.</li>
        </ul>

        <h3>3. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ / –∏–º–ø–æ—Ä—Ç</h3>
        <ul>
            <li>¬´–î–æ–±–∞–≤–∏—Ç—å –≥—Ä—É–ø–ø—É¬ª ‚Äî —Ä—É—á–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π –≥—Ä—É–ø–ø—ã.</li>
            <li>¬´–ò–º–ø–æ—Ä—Ç –∏–∑ Excel¬ª ‚Äî –¥–æ–≥—Ä—É–∂–∞–µ—Ç/–æ–±–Ω–æ–≤–ª—è–µ—Ç –≥—Ä—É–ø–ø—ã –∏–∑ —Ç–∞–±–ª–∏—Ü—ã (–≥–ª–∞–≤–Ω—ã–π –®–ö, –Ω–∞–∑–≤–∞–Ω–∏–µ, —Å–∏–Ω–æ–Ω–∏–º—ã —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é).</li>
        </ul>

        <h3>4. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤</h3>
        <ul>
            <li>–ö–Ω–æ–ø–∫–∞ ¬´–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã¬ª –∏—â–µ—Ç —à—Ç—Ä–∏—Ö–∫–æ–¥—ã, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ–ø–∞–ª–∏ –≤ –Ω–µ—Å–∫–æ–ª—å–∫–æ –≥—Ä—É–ø–ø.</li>
            <li>–ö–æ–Ω—Ñ–ª–∏–∫—Ç–Ω—ã–µ –≥—Ä—É–ø–ø—ã –ø–æ–¥—Å–≤–µ—á–∏–≤–∞—é—Ç—Å—è –∫—Ä–∞—Å–Ω—ã–º.</li>
        </ul>

        <h3>5. –≠–∫—Å–ø–æ—Ä—Ç</h3>
        <ul>
            <li>¬´–°–∫–∞—á–∞—Ç—å JSON¬ª ‚Äî —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π —Ñ–∞–π–ª –¥–ª—è —Å—Ä–∞–≤–Ω–∏—Ç–µ–ª—è.</li>
            <li>¬´–°–∫–∞—á–∞—Ç—å Excel¬ª ‚Äî —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç –≤—Å–µ –≥—Ä—É–ø–ø—ã –¥–ª—è —É–¥–æ–±–Ω–æ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∏ –ø—Ä–∞–≤–æ–∫.</li>
        </ul>
    </div>

    <div id="infoPanel" class="info-grid" style="display:none;">
        <div class="info-card">
            <div class="info-value" id="groupCount">0</div>
            <div class="info-label">–ì—Ä—É–ø–ø —Å–∏–Ω–æ–Ω–∏–º–æ–≤</div>
        </div>
        <div class="info-card">
            <div class="info-value" id="synonymCount">0</div>
            <div class="info-label">–í—Å–µ–≥–æ —Å–∏–Ω–æ–Ω–∏–º–æ–≤</div>
        </div>
        <div class="info-card">
            <div class="info-value" id="barcodeCount">0</div>
            <div class="info-label">–£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö —à—Ç—Ä–∏—Ö–∫–æ–¥–æ–≤</div>
        </div>
        <div class="info-card">
            <div class="info-value" id="conflictCount">0</div>
            <div class="info-label">–ö–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤</div>
        </div>
    </div>

    <div id="addGroupSection" class="add-group-section" style="display:none;">
        <div class="add-group-title">‚ûï –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é –≥—Ä—É–ø–ø—É —Å–∏–Ω–æ–Ω–∏–º–æ–≤</div>
        <div class="add-group-form">
            <input type="text" id="newMainBarcode" placeholder="–ì–ª–∞–≤–Ω—ã–π —à—Ç—Ä–∏—Ö–∫–æ–¥ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 1234567890)" />
            <input type="text" id="newGroupName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞" />
            <textarea id="newSynonyms" placeholder="–°–∏–Ω–æ–Ω–∏–º—ã —à—Ç—Ä–∏—Ö–∫–æ–¥–æ–≤ (–∫–∞–∂–¥—ã–π —Å –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏)"></textarea>
            <div style="display: flex; gap: 6px;">
                <button class="btn btn-success" onclick="saveNewGroup()">
                    <span class="icon">‚úì</span> –°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É
                </button>
                <button class="btn btn-secondary" onclick="cancelNewGroup()">
                    <span class="icon">‚úï</span> –û—Ç–º–µ–Ω–∞
                </button>
            </div>
        </div>
    </div>

    <div id="groupsContainer"></div>
</div>

<script>
    let synonymsData = {};
    let conflicts = new Set();
    let searchQuery = '';
    let sortByNameAsc = true;

    const fileInput = document.getElementById('fileInput');
    const fileStatus = document.getElementById('fileStatus');
    const searchInput = document.getElementById('searchInput');
    const addGroupBtn = document.getElementById('addGroupBtn');
    const checkConflictsBtn = document.getElementById('checkConflictsBtn');
    const sortByNameBtn = document.getElementById('sortByNameBtn');
    const toggleInstructionsBtn = document.getElementById('toggleInstructionsBtn');
    const exportJsonBtn = document.getElementById('exportJsonBtn');
    const exportExcelBtn = document.getElementById('exportExcelBtn');
    const importExcelBtn = document.getElementById('importExcelBtn');
    const excelImportInput = document.getElementById('excelImportInput');
    const clearBtn = document.getElementById('clearBtn');
    const instructionsPanel = document.getElementById('instructionsPanel');
    const infoPanel = document.getElementById('infoPanel');
    const groupsContainer = document.getElementById('groupsContainer');
    const addGroupSection = document.getElementById('addGroupSection');

    fileInput.addEventListener('change', handleFileUpload);
    searchInput.addEventListener('input', handleSearch);
    addGroupBtn.addEventListener('click', showAddGroupForm);
    checkConflictsBtn.addEventListener('click', checkConflicts);
    sortByNameBtn.addEventListener('click', toggleSortByName);
    toggleInstructionsBtn.addEventListener('click', toggleInstructions);
    exportJsonBtn.addEventListener('click', exportJson);
    exportExcelBtn.addEventListener('click', exportExcel);
    importExcelBtn.addEventListener('click', () => excelImportInput.click());
    excelImportInput.addEventListener('change', handleExcelImport);
    clearBtn.addEventListener('click', clearAll);

    function handleFileUpload(e) {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (event) => {
            try {
                const json = JSON.parse(event.target.result);
                synonymsData = json;
                fileStatus.style.color = '#34c759';
                fileStatus.textContent = `–§–∞–π–ª –∑–∞–≥—Ä—É–∂–µ–Ω: ${file.name}`;
                updateUI();
                renderGroups();
            } catch (err) {
                console.error('–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è JSON:', err);
                fileStatus.style.color = '#ff3b30';
                fileStatus.textContent = '–û—à–∏–±–∫–∞: –Ω–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç JSON';
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–æ—Ä–º–∞—Ç JSON.');
            }
        };
        reader.onerror = () => {
            fileStatus.style.color = '#ff3b30';
            fileStatus.textContent = '–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞';
            alert('–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Ñ–∞–π–ª.');
        };
        reader.readAsText(file, 'utf-8');
    }

    function handleSearch(e) {
        searchQuery = e.target.value.toLowerCase().trim();
        renderGroups();
    }

    function toggleInstructions() {
        const isVisible = instructionsPanel.style.display === 'block';
        instructionsPanel.style.display = isVisible ? 'none' : 'block';
        if (isVisible) toggleInstructionsBtn.classList.remove('active');
        else toggleInstructionsBtn.classList.add('active');
    }

    function toggleSortByName() {
        sortByNameAsc = !sortByNameAsc;
        if (sortByNameAsc) {
            sortByNameBtn.classList.add('active');
        } else {
            sortByNameBtn.classList.remove('active');
        }
        renderGroups();
    }

    function showAddGroupForm() {
        addGroupSection.style.display = 'block';
        document.getElementById('newMainBarcode').focus();
    }

    function cancelNewGroup() {
        addGroupSection.style.display = 'none';
        document.getElementById('newMainBarcode').value = '';
        document.getElementById('newGroupName').value = '';
        document.getElementById('newSynonyms').value = '';
    }

    function saveNewGroup() {
        const mainBarcode = document.getElementById('newMainBarcode').value.trim();
        const groupName = document.getElementById('newGroupName').value.trim();
        const synonymsText = document.getElementById('newSynonyms').value.trim();

        if (!mainBarcode) {
            alert('–í–≤–µ–¥–∏—Ç–µ –≥–ª–∞–≤–Ω—ã–π —à—Ç—Ä–∏—Ö–∫–æ–¥');
            return;
        }

        if (synonymsData[mainBarcode]) {
            alert('–ì—Ä—É–ø–ø–∞ —Å —Ç–∞–∫–∏–º —à—Ç—Ä–∏—Ö–∫–æ–¥–æ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç');
            return;
        }

        const synonyms = synonymsText
            .split('\n')
            .map(s => s.trim())
            .filter(s => s !== '');

        synonymsData[mainBarcode] = [groupName || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è', ...synonyms];
        
        cancelNewGroup();
        updateUI();
        renderGroups();
    }

    function deleteGroup(mainBarcode) {
        if (!confirm(`–£–¥–∞–ª–∏—Ç—å –≥—Ä—É–ø–ø—É ${mainBarcode}?`)) return;
        delete synonymsData[mainBarcode];
        updateUI();
        renderGroups();
    }

    function updateGroupName(mainBarcode, newName) {
        if (synonymsData[mainBarcode]) {
            synonymsData[mainBarcode][0] = newName;
        }
    }

    function addSynonym(mainBarcode, synonym) {
        if (!synonym || !synonym.trim()) return;
        synonym = synonym.trim();
        
        if (!synonymsData[mainBarcode]) return;
        
        const arr = synonymsData[mainBarcode];
        if (arr.slice(1).includes(synonym)) {
            alert('–¢–∞–∫–æ–π —Å–∏–Ω–æ–Ω–∏–º —É–∂–µ –µ—Å—Ç—å –≤ —ç—Ç–æ–π –≥—Ä—É–ø–ø–µ');
            return;
        }
        
        arr.push(synonym);
        renderGroups();
        updateUI();
    }

    function removeSynonym(mainBarcode, synonym) {
        if (!synonymsData[mainBarcode]) return;
        
        const arr = synonymsData[mainBarcode];
        const index = arr.indexOf(synonym);
        if (index > 0) {
            arr.splice(index, 1);
            renderGroups();
            updateUI();
        }
    }

    function checkConflicts() {
        conflicts.clear();
        const barcodeToGroups = new Map();
        
        Object.keys(synonymsData).forEach(mainBarcode => {
            const arr = synonymsData[mainBarcode];
            const barcodes = [mainBarcode, ...arr.slice(1)];
            
            barcodes.forEach(bc => {
                if (!barcodeToGroups.has(bc)) {
                    barcodeToGroups.set(bc, []);
                }
                barcodeToGroups.get(bc).push(mainBarcode);
            });
        });
        
        barcodeToGroups.forEach((groups, barcode) => {
            if (groups.length > 1) {
                groups.forEach(g => conflicts.add(g));
            }
        });
        
        updateUI();
        renderGroups();
        
        if (conflicts.size > 0) {
            alert(`–ù–∞–π–¥–µ–Ω–æ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤: ${conflicts.size} –≥—Ä—É–ø–ø —Å–æ–¥–µ—Ä–∂–∞—Ç –¥—É–±–ª–∏—Ä—É—é—â–∏–µ—Å—è —à—Ç—Ä–∏—Ö–∫–æ–¥—ã`);
        } else {
            alert('–ö–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ! ‚úì');
        }
    }

    function renderGroups() {
        let groups = Object.keys(synonymsData);
        
        if (searchQuery) {
            groups = groups.filter(mainBarcode => {
                const arr = synonymsData[mainBarcode];
                const name = arr[0] || '';
                const synonyms = arr.slice(1);
                
                return mainBarcode.toLowerCase().includes(searchQuery) ||
                       name.toLowerCase().includes(searchQuery) ||
                       synonyms.some(s => s.toLowerCase().includes(searchQuery));
            });
        }

        if (groups.length > 0) {
            groups.sort((a, b) => {
                const arrA = synonymsData[a] || [];
                const arrB = synonymsData[b] || [];
                const nameA = (arrA[0] || '').toLowerCase();
                const nameB = (arrB[0] || '').toLowerCase();

                if (nameA < nameB) return sortByNameAsc ? -1 : 1;
                if (nameA > nameB) return sortByNameAsc ? 1 : -1;
                if (a < b) return -1;
                if (a > b) return 1;
                return 0;
            });
        }
        
        if (groups.length === 0) {
            groupsContainer.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">üì¶</div>
                    <h3>–ù–µ—Ç –≥—Ä—É–ø–ø —Å–∏–Ω–æ–Ω–∏–º–æ–≤</h3>
                    <p>–ó–∞–≥—Ä—É–∑–∏—Ç–µ JSON —Ñ–∞–π–ª –∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—É—é –≥—Ä—É–ø–ø—É</p>
                </div>`;
            return;
        }
        
        let html = '<div class="groups-container">';
        
        groups.forEach(mainBarcode => {
            const arr = synonymsData[mainBarcode];
            const name = arr[0] || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è';
            const synonyms = arr.slice(1);
            const hasConflict = conflicts.has(mainBarcode);
            
            html += `
                <div class="group-card ${hasConflict ? 'has-conflict' : ''}">
                    <div class="group-header">
                        <div class="group-main-info">
                            <div class="group-barcode">${mainBarcode}</div>
                            <div class="group-name">
                                <input type="text" 
                                       value="${name.replace(/"/g, '&quot;')}"
                                       onchange="updateGroupName('${mainBarcode}', this.value)"
                                       placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞" />
                            </div>
                        </div>
                        <div class="group-actions">
                            <button class="group-btn group-btn-delete" 
                                    onclick="deleteGroup('${mainBarcode}')"
                                    title="–£–¥–∞–ª–∏—Ç—å –≥—Ä—É–ø–ø—É">
                                üóëÔ∏è
                            </button>
                        </div>
                    </div>
                    
                    <div class="synonyms-list">`;
            
            synonyms.forEach(syn => {
                html += `
                    <div class="synonym-tag ${hasConflict ? 'conflict' : ''}">
                        ${syn}
                        <button class="synonym-remove" 
                                onclick="removeSynonym('${mainBarcode}', '${syn}')"
                                title="–£–¥–∞–ª–∏—Ç—å —Å–∏–Ω–æ–Ω–∏–º">
                            ‚úï
                        </button>
                    </div>`;
            });
            
            html += `</div>
                    
                    <div class="add-synonym">
                        <input type="text" 
                               id="syn-input-${mainBarcode}"
                               placeholder="–î–æ–±–∞–≤–∏—Ç—å —Å–∏–Ω–æ–Ω–∏–º..."
                               onkeypress="if(event.key==='Enter'){addSynonym('${mainBarcode}', this.value); this.value='';}" />
                        <button onclick="const inp=document.getElementById('syn-input-${mainBarcode}'); addSynonym('${mainBarcode}', inp.value); inp.value='';">
                            ‚ûï –î–æ–±–∞–≤–∏—Ç—å
                        </button>
                    </div>`;
            
            if (hasConflict) {
                html += `<div class="conflict-warning">‚ö†Ô∏è –≠—Ç–∞ –≥—Ä—É–ø–ø–∞ —Å–æ–¥–µ—Ä–∂–∏—Ç –¥—É–±–ª–∏—Ä—É—é—â–∏–µ—Å—è —à—Ç—Ä–∏—Ö–∫–æ–¥—ã</div>`;
            }
            
            html += `</div>`;
        });
        
        html += '</div>';
        groupsContainer.innerHTML = html;
    }

    function updateUI() {
        const hasData = Object.keys(synonymsData).length > 0;
        
        searchInput.disabled = !hasData;
        addGroupBtn.disabled = !hasData;
        checkConflictsBtn.disabled = !hasData;
        sortByNameBtn.disabled = !hasData;
        exportJsonBtn.disabled = !hasData;
        exportExcelBtn.disabled = !hasData;
        importExcelBtn.disabled = !hasData;
        clearBtn.disabled = !hasData;
        
        if (hasData) {
            infoPanel.style.display = 'grid';
            
            const groupCount = Object.keys(synonymsData).length;
            let synonymCount = 0;
            const allBarcodes = new Set();
            
            Object.keys(synonymsData).forEach(mainBarcode => {
                allBarcodes.add(mainBarcode);
                const arr = synonymsData[mainBarcode];
                const synonyms = arr.slice(1);
                synonymCount += synonyms.length;
                synonyms.forEach(s => allBarcodes.add(s));
            });
            
            document.getElementById('groupCount').textContent = groupCount;
            document.getElementById('synonymCount').textContent = synonymCount;
            document.getElementById('barcodeCount').textContent = allBarcodes.size;
            document.getElementById('conflictCount').textContent = conflicts.size;
        } else {
            infoPanel.style.display = 'none';
        }
    }

    function exportJson() {
        const json = JSON.stringify(synonymsData, null, 2);
        const blob = new Blob([json], { type: 'application/json' });
        const now = new Date();
        const yyyy = now.getFullYear();
        const mm = String(now.getMonth() + 1).padStart(2, '0');
        const dd = String(now.getDate()).padStart(2, '0');
        const fileName = `synonyms-${yyyy}-${mm}-${dd}.json`;
        saveAs(blob, fileName);
    }

    async function exportExcel() {
        const workbook = new ExcelJS.Workbook();
        const worksheet = workbook.addWorksheet('–°–∏–Ω–æ–Ω–∏–º—ã');
        
        worksheet.addRow(['–ì–ª–∞–≤–Ω—ã–π —à—Ç—Ä–∏—Ö–∫–æ–¥', '–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞', '–°–∏–Ω–æ–Ω–∏–º—ã (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)']);
        
        Object.keys(synonymsData).forEach(mainBarcode => {
            const arr = synonymsData[mainBarcode];
            const name = arr[0] || '';
            const synonyms = arr.slice(1).join(', ');
            worksheet.addRow([mainBarcode, name, synonyms]);
        });
        
        worksheet.columns.forEach((column, idx) => {
            if (idx === 0) column.width = 20;
            else if (idx === 1) column.width = 40;
            else column.width = 60;
        });
        
        const headerRow = worksheet.getRow(1);
        headerRow.font = { bold: true };
        headerRow.fill = { type:'pattern', pattern:'solid', fgColor:{ argb:'FFE0E0E0' } };
        
        worksheet.eachRow((row) => {
            row.eachCell((cell) => {
                cell.border = {
                    top: { style: 'thin' },
                    left: { style: 'thin' },
                    bottom: { style: 'thin' },
                    right: { style: 'thin' }
                };
            });
        });
        
        const buffer = await workbook.xlsx.writeBuffer();
        const now = new Date();
        const yyyy = now.getFullYear();
        const mm = String(now.getMonth() + 1).padStart(2, '0');
        const dd = String(now.getDate()).padStart(2, '0');
        const fileName = `synonyms-${yyyy}-${mm}-${dd}.xlsx`;
        const blob = new Blob([buffer], {
            type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
        });
        saveAs(blob, fileName);
    }

    function handleExcelImport(e) {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (event) => {
            try {
                const data = new Uint8Array(event.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const rows = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });

                if (!rows || rows.length < 2) {
                    alert('–í Excel –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞');
                    return;
                }

                rows.slice(1).forEach(row => {
                    const mainBarcode = String(row[0] || '').trim();
                    const name = String(row[1] || '').trim();
                    const synonymsRaw = String(row[2] || '').trim();

                    if (!mainBarcode) return;

                    const synonyms = synonymsRaw
                        ? synonymsRaw
                            .split(/[,;]/)
                            .map(s => s.trim())
                            .filter(s => s !== '')
                        : [];

                    if (!synonymsData[mainBarcode]) {
                        synonymsData[mainBarcode] = [name || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è', ...synonyms];
                    } else {
                        const arr = synonymsData[mainBarcode];
                        if (name) {
                            arr[0] = name;
                        }
                        const existing = new Set(arr.slice(1));
                        synonyms.forEach(s => {
                            if (!existing.has(s)) {
                                arr.push(s);
                                existing.add(s);
                            }
                        });
                    }
                });

                alert('–ò–º–ø–æ—Ä—Ç –∏–∑ Excel –≤—ã–ø–æ–ª–Ω–µ–Ω');
                updateUI();
                renderGroups();
            } catch (err) {
                console.error('–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ Excel:', err);
                alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å Excel. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞.');
            } finally {
                excelImportInput.value = '';
            }
        };
        reader.onerror = () => {
            alert('–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è Excel-—Ñ–∞–π–ª–∞');
            excelImportInput.value = '';
        };
        reader.readAsArrayBuffer(file);
    }

    function clearAll() {
        if (!confirm('–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.')) return;
        
        synonymsData = {};
        conflicts.clear();
        searchQuery = '';
        sortByNameAsc = true;
        
        fileInput.value = '';
        excelImportInput.value = '';
        searchInput.value = '';
        fileStatus.style.color = '#8e8e93';
        fileStatus.textContent = '–§–∞–π–ª –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω';
        sortByNameBtn.classList.remove('active');
        
        groupsContainer.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">üì¶</div>
                <h3>–ù–µ—Ç –≥—Ä—É–ø–ø —Å–∏–Ω–æ–Ω–∏–º–æ–≤</h3>
                <p>–ó–∞–≥—Ä—É–∑–∏—Ç–µ JSON —Ñ–∞–π–ª –∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—É—é –≥—Ä—É–ø–ø—É</p>
            </div>`;
        
        updateUI();
    }

    window.deleteGroup = deleteGroup;
    window.updateGroupName = updateGroupName;
    window.addSynonym = addSynonym;
    window.removeSynonym = removeSynonym;
    window.saveNewGroup = saveNewGroup;
    window.cancelNewGroup = cancelNewGroup;
</script>
</body>
</html>
