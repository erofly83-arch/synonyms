<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>–†–µ–¥–∞–∫—Ç–æ—Ä —Å–∏–Ω–æ–Ω–∏–º–æ–≤ —à—Ç—Ä–∏—Ö–∫–æ–¥–æ–≤</title>
  <link rel="icon" href="data:image/svg+xml,<?xml version='1.0' encoding='UTF-8'?> <svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text x='50%25' y='50%25' dominant-baseline='central' text-anchor='middle' font-size='80'>üîó</text></svg>">

  <!-- libs -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/exceljs@4.3.0/dist/exceljs.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <style>
/* ===== RESET ===== */
* { margin: 0; padding: 0; box-sizing: border-box; }

/* ===== BODY & BACKGROUND ===== */
body {
  font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', Arial, sans-serif;
  background: linear-gradient(135deg, #4f8ef7 0%, #7c3aed 55%, #a21caf 100%);
  min-height: 100vh;
  padding: 0 0 32px 0;
  color: #1c1c1e;
}

/* ===== GLOBAL NAV ===== */
.global-nav {
  position: sticky;
  top: 0;
  z-index: 5000;
  background: linear-gradient(90deg, #3b6fd4 0%, #6d28d9 60%, #9c1ac4 100%);
  box-shadow: 0 4px 20px rgba(80,0,120,0.35);
  border-bottom: none;
}
.global-nav__inner {
  max-width: 100%;
  margin: 0 auto;
  padding: 0 24px;
  display: flex;
  align-items: center;
  gap: 12px;
  flex-wrap: wrap;
  min-height: 52px;
}
.global-nav__brand {
  text-decoration: none;
  font-weight: 800;
  font-size: 17px;
  color: #ffffff;
  white-space: nowrap;
  letter-spacing: -0.3px;
  text-shadow: 0 1px 4px rgba(0,0,0,0.2);
}
.global-nav__links {
  display: flex;
  gap: 6px;
  flex-wrap: wrap;
  align-items: center;
}
.global-nav__link {
  text-decoration: none;
  font-size: 13px;
  font-weight: 650;
  color: rgba(255,255,255,0.88);
  background: rgba(255,255,255,0.13);
  border: 1px solid rgba(255,255,255,0.22);
  padding: 7px 14px;
  border-radius: 999px;
  white-space: nowrap;
  transition: transform .12s ease, background .12s ease;
}
.global-nav__link:hover {
  transform: translateY(-1px);
  background: rgba(255,255,255,0.24);
  color: #fff;
}
.global-nav__link.is-active {
  color: #6d28d9;
  background: #ffffff;
  border-color: #ffffff;
  font-weight: 700;
}

/* ===== MAIN CONTAINER ===== */
.container {
  max-width: 100%;
  margin: 20px 16px 0;
  background: #ffffff;
  border-radius: 20px;
  padding: 24px;
  box-shadow: 0 8px 40px rgba(80,0,120,0.22);
}

h1 {
  font-size: 22px;
  font-weight: 800;
  margin-bottom: 16px;
  color: #1c1c1e;
  letter-spacing: -0.4px;
}

/* ===== TOPBAR ===== */
.topbar {
  display: flex;
  align-items: center;
  gap: 8px;
  flex-wrap: nowrap;
  overflow-x: auto;
  padding: 10px 12px;
  border: 1px solid #ddd6fe;
  border-radius: 14px;
  background: #f5f3ff;
  margin-bottom: 14px;
}
.file-inline { display: flex; align-items: center; gap: 8px; flex: 0 0 auto; }
.file-input-wrapper { position: relative; flex: 0 0 auto; }
.file-input-wrapper input[type="file"] { position: absolute; inset: 0; opacity: 0; width: 100%; height: 100%; cursor: pointer; }
.file-input-display {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 7px 12px;
  background: white;
  border-radius: 10px;
  font-size: 13px;
  color: #7c3aed;
  font-weight: 700;
  cursor: pointer;
  border: 1px solid #c4b5fd;
  transition: all 0.2s;
  white-space: nowrap;
  height: 32px;
}
.file-input-display:hover { background: #ede9fe; border-color: #7c3aed; }
.status-inline {
  font-size: 11px;
  color: #8e8e93;
  white-space: nowrap;
  max-width: 360px;
  overflow: hidden;
  text-overflow: ellipsis;
}
.controls { display: flex; gap: 6px; flex-wrap: nowrap; margin: 0; flex: 0 0 auto; }

/* ===== BUTTONS ===== */
.btn {
  padding: 7px 12px;
  border: none;
  border-radius: 9px;
  cursor: pointer;
  font-weight: 700;
  font-size: 12px;
  transition: all 0.18s;
  display: inline-flex;
  align-items: center;
  gap: 4px;
  line-height: 1;
  white-space: nowrap;
  user-select: none;
  height: 32px;
}
.btn span.icon { font-size: 14px; }
.btn-primary { background: #1a73e8; color: white; }
.btn-primary:hover { background: #1558c0; transform: translateY(-1px); box-shadow: 0 3px 10px rgba(26,115,232,0.35); }
.btn-success { background: #1a73e8; color: white; }
.btn-success:hover { background: #1558c0; transform: translateY(-1px); box-shadow: 0 3px 10px rgba(26,115,232,0.35); }
.btn-warning { background: #ff9500; color: white; }
.btn-warning:hover { background: #e08600; transform: translateY(-1px); box-shadow: 0 3px 8px rgba(255,149,0,0.3); }
.btn-danger { background: #e11d48; color: white; }
.btn-danger:hover { background: #be123c; transform: translateY(-1px); box-shadow: 0 3px 8px rgba(225,29,72,0.3); }
.btn-secondary {
  background: #ffffff;
  color: #1a73e8;
  border: 1.5px solid #c4b5fd;
}
.btn-secondary:hover { background: #ede9fe; border-color: #7c3aed; color: #7c3aed; }
.btn:disabled { background: #e5e5ea; color: #aeaeb2; cursor: not-allowed; transform: none; box-shadow: none; border-color: #e5e5ea; }

/* ===== INFO CARDS ===== */
.info-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
  gap: 10px;
  margin-bottom: 14px;
}
.info-card {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  border-radius: 14px;
  padding: 12px 16px;
  color: white;
}
.info-card:nth-child(2) { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
.info-card:nth-child(3) { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
.info-card:nth-child(4) { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); }
.info-value { font-size: 22px; font-weight: 700; margin-bottom: 2px; letter-spacing: -0.5px; }
.info-label { font-size: 11px; opacity: 0.9; font-weight: 500; }

/* ===== SEARCH ===== */
.search-wide {
  width: 100%;
  padding: 10px 14px;
  border: 2px solid #c4b5fd;
  border-radius: 12px;
  font-size: 14px;
  font-family: inherit;
  background: #faf8ff;
  transition: all 0.2s;
  margin: 0 0 14px;
}
.search-wide:focus { outline: none; border-color: #7c3aed; background: #f3f0ff; box-shadow: 0 0 0 3px rgba(124,58,237,0.1); }

/* ===== GRID ===== */
.rows-wrap { width: 100%; overflow-x: auto; }
.grid {
  display: grid;
  grid-template-columns: 1.2fr 0.9fr 2fr 1.1fr 44px 110px;
  gap: 8px;
  align-items: center;
  min-width: 1180px;
}
.grid > * { min-width: 0; }

/* ===== INPUTS ===== */
.inp {
  height: 28px;
  padding: 1px 10px;
  border: 1.5px solid #c4b5fd;
  border-radius: 8px;
  font-size: 12px;
  font-family: inherit;
  background: #faf8ff;
  min-width: 0;
  transition: all 0.15s;
}
.inp:focus { outline: none; border-color: #7c3aed; background: #f3f0ff; box-shadow: 0 0 0 2px rgba(124,58,237,0.1); }
.inp-mono { font-family: "Courier New", monospace; font-weight: 700; letter-spacing: 0.2px; }
.inp-name { font-weight: 400; }

/* ===== BARCODE CELL ===== */
.main-cell {
  display: flex;
  align-items: center;
  gap: 6px;
  min-width: 0;
}
.main-cell .inp { flex: 1 1 auto; min-width: 0; }
.loupe-link {
  width: 24px;
  min-width: 24px;
  height: 24px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  border: 1px solid #c4b5fd;
  border-radius: 8px;
  background: #f5f3ff;
  color: #7c3aed;
  text-decoration: none;
  font-size: 12px;
  line-height: 1;
  user-select: none;
}
.loupe-link:hover { background: #ede9fe; border-color: #7c3aed; }

/* ===== SYNONYMS ===== */
.synonyms-cell {
  display: flex;
  gap: 6px;
  align-items: center;
  flex-wrap: nowrap;
  overflow-x: auto;
  padding: 1px 2px;
  height: 28px;
  width: 100%;
  min-width: 0;
  max-width: 100%;
}
.synonym-pill {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 2px 10px;
  height: 22px;
  background: #ede9fe;
  border: 1px solid #c4b5fd;
  border-radius: 999px;
  font-size: 12px;
  font-family: "Courier New", monospace;
  white-space: nowrap;
  flex: 0 0 auto;
  color: #1c1c1e;
}
.synonym-pill.syn-link { cursor: pointer; }
.synonym-pill.syn-link:hover { background: #ddd6fe; border-color: #a78bfa; }
.row.has-conflict .synonym-pill { background: #ffe6e6; border-color: #e11d48; }

.synonym-remove {
  border: none;
  background: none;
  color: #e11d48;
  cursor: pointer;
  font-size: 14px;
  line-height: 1;
  padding: 0;
  height: 16px;
}
.synonym-remove:hover { color: #be123c; }

/* ===== ROW BUTTONS ===== */
.btn-disk {
  width: 44px;
  min-width: 44px;
  padding: 0;
  justify-content: center;
  border-radius: 9px;
  height: 28px;
  font-size: 13px;
  font-weight: 700;
}
.btn-del {
  height: 28px;
  border-radius: 9px;
  padding: 0 10px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
  font-size: 11px;
}

/* ===== NEW GROUP CARD ===== */
.new-group {
  background: #f5f3ff;
  border: 2px dashed #a78bfa;
  border-radius: 16px;
  padding: 12px;
  margin-bottom: 12px;
  transition: all 0.2s;
}
.new-group:hover { border-color: #7c3aed; }

/* ===== GROUP ROWS ===== */
.row {
  background: #faf8ff;
  border-radius: 14px;
  padding: 8px 12px;
  border: 1.5px solid #ddd6fe;
  transition: all .15s;
  margin-bottom: 8px;
}
.row:hover { border-color: #a78bfa; background: #f5f3ff; }
.row.has-conflict { border-color: #e11d48; background: #fff5f5; }

/* ===== EMPTY STATE ===== */
.empty-state {
  text-align: center;
  padding: 40px 20px;
  color: #8e8e93;
}
.empty-state-icon { font-size: 48px; margin-bottom: 12px; }
.empty-state h3 { font-size: 18px; font-weight: 600; margin-bottom: 6px; color: #1c1c1e; }
.empty-state p { font-size: 13px; }

/* ===== RESPONSIVE ===== */
@media (max-width: 900px) { .container { margin: 12px 8px 0; padding: 16px; } }

:root { --global-nav-h: 52px; }
</style>
</head>

<body>
<header class="global-nav">
  <div class="global-nav__inner">
    <a class="global-nav__brand" href="https://erofly83-arch.github.io/pricematcher/">
      –ù–∞–≤–∏–≥–∞—Ç–æ—Ä
    </a>

    <nav class="global-nav__links" aria-label="–ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è–º">
      <a class="global-nav__link" href="https://erofly83-arch.github.io/synonyms/" data-match="/synonyms/">
        –†–µ–¥–∞–∫—Ç–æ—Ä JSON
      </a>
      <a class="global-nav__link" href="https://erofly83-arch.github.io/pricematcher/" data-match="/pricematcher/">
        –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
      </a>
      <a class="global-nav__link" href="https://erofly83-arch.github.io/obrezatel/" data-match="/obrezatel/">
        –û–±—Ä–µ–∑–∞—Ç–µ–ª—å
      </a>
      <a class="global-nav__link" href="https://erofly83-arch.github.io/sininimfinder/" data-match="/sininimfinder/">
        –ü–æ–∏—Å–∫ —Å–∏–Ω–æ–Ω–∏–º–æ–≤
      </a>
    </nav>
  </div>
</header>

  <div class="container">
    <h1>üîó –†–µ–¥–∞–∫—Ç–æ—Ä —Å–∏–Ω–æ–Ω–∏–º–æ–≤ —à—Ç—Ä–∏—Ö–∫–æ–¥–æ–≤</h1>

    <div class="topbar">
      <div class="file-inline">
        <div class="file-input-wrapper" style="min-width: 190px;">
          <input type="file" id="fileInput" accept=".json" />
          <div class="file-input-display" title="–ó–∞–≥—Ä—É–∑–∏—Ç—å JSON">
            <span>üìÑ</span><span>synonyms.json</span>
          </div>
        </div>
        <div id="fileStatus" class="status-inline">–§–∞–π–ª –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω</div>
      </div>

      <div class="controls">
        <button id="exportJsonBtn" class="btn btn-success" disabled title="–°–∫–∞—á–∞—Ç—å JSON">–°–∫–∞—á–∞—Ç—å JSON</button>
        <button id="exportExcelBtn" class="btn btn-secondary" disabled title="–°–∫–∞—á–∞—Ç—å Excel">–°–∫–∞—á–∞—Ç—å Excel</button>
        <button id="importExcelBtn" class="btn btn-secondary" title="–ó–∞–≥—Ä—É–∑–∏—Ç—å Excel">–ó–∞–≥—Ä—É–∑–∏—Ç—å Excel</button>
        <button id="exportSelfBtn" class="btn btn-success" disabled title="–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ (html —Ñ–∞–π–ª)">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button id="clearBtn" class="btn btn-danger" disabled title="–û—á–∏—Å—Ç–∏—Ç—å">–û—á–∏—Å—Ç–∏—Ç—å</button>
        <input type="file" id="excelImportInput" accept=".xlsx,.xls" style="display:none;" />
      </div>
    </div>

    <div id="infoPanel" class="info-grid" style="display:none;">
      <div class="info-card">
        <div class="info-value" id="groupCount">0</div>
        <div class="info-label">–ì—Ä—É–ø–ø</div>
      </div>
      <div class="info-card">
        <div class="info-value" id="synonymCount">0</div>
        <div class="info-label">–°–∏–Ω–æ–Ω–∏–º–æ–≤</div>
      </div>
      <div class="info-card">
        <div class="info-value" id="barcodeCount">0</div>
        <div class="info-label">–®–ö —É–Ω–∏–∫.</div>
      </div>
      <div class="info-card">
        <div class="info-value" id="conflictCount">0</div>
        <div class="info-label">–ö–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤</div>
      </div>
    </div>

    <input type="text" id="searchInput" class="search-wide" placeholder="–ü–æ–∏—Å–∫ –ø–æ –®–ö / –Ω–∞–∑–≤–∞–Ω–∏—é / —Å–∏–Ω–æ–Ω–∏–º–∞–º..." disabled />

    <!-- NEW GROUP -->
    <div class="new-group">
      <div class="rows-wrap">
        <div class="grid">
          <input class="inp inp-name" type="text" id="newGroupName" placeholder="–ö–∞—Ç–µ–≥–æ—Ä–∏—è (–Ω–∞–∑–≤–∞–Ω–∏–µ)" />
          <input class="inp inp-mono" type="text" id="newMainBarcode" placeholder="–ì–ª–∞–≤–Ω—ã–π –®–ö" />
          <input class="inp inp-mono" type="text" id="newSynonyms" placeholder="–°–∏–Ω–æ–Ω–∏–º—ã —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é" />
          <div></div>
          <button id="createGroupBtn" class="btn btn-success btn-disk" title="–°–æ—Ö—Ä–∞–Ω–∏—Ç—å">üíæ</button>
          <button id="clearNewGroupBtn" class="btn btn-secondary btn-del" title="–°–±—Ä–æ—Å">–°–±—Ä–æ—Å</button>
        </div>
      </div>
    </div>

    <!-- GROUPS -->
    <div class="rows-wrap">
      <div id="groupsContainer"></div>
    </div>
  </div>

  <!-- Embedded data for self-save -->
  <script id="embeddedData" type="application/json"></script>

  <script>
    // state
    let synonymsData = {};
    let conflicts = new Set();
    let searchQuery = "";

    // DOM
    const fileInput = document.getElementById("fileInput");
    const fileStatus = document.getElementById("fileStatus");
    const searchInput = document.getElementById("searchInput");
    const exportJsonBtn = document.getElementById("exportJsonBtn");
    const exportExcelBtn = document.getElementById("exportExcelBtn");
    const importExcelBtn = document.getElementById("importExcelBtn");
    const exportSelfBtn = document.getElementById("exportSelfBtn");
    const clearBtn = document.getElementById("clearBtn");
    const excelImportInput = document.getElementById("excelImportInput");
    const groupsContainer = document.getElementById("groupsContainer");
    const infoPanel = document.getElementById("infoPanel");
    const newMainBarcodeEl = document.getElementById("newMainBarcode");
    const newGroupNameEl = document.getElementById("newGroupName");
    const newSynonymsEl = document.getElementById("newSynonyms");
    const createGroupBtn = document.getElementById("createGroupBtn");
    const clearNewGroupBtn = document.getElementById("clearNewGroupBtn");

    // helpers
    function normalizeBarcode(value) { return String(value ?? "").trim(); }
    function normalizeName(value) { return String(value ?? "").trim(); }
    function splitSynonyms(text) {
      const raw = String(text ?? "").trim();
      if (!raw) return [];
      return raw.split(",").map(s => s.trim()).filter(Boolean);
    }
    function safeIdFrom(str) {
      const s = String(str ?? "");
      try {
        const b64 = btoa(unescape(encodeURIComponent(s))).replaceAll("=", "");
        return b64.replaceAll("+", "-").replaceAll("/", "_");
      } catch (e) {
        return s.replace(/[^a-zA-Z0-9_-]/g, "_");
      }
    }
    function setStatusOk(text) { fileStatus.style.color = "#34c759"; fileStatus.textContent = text; }
    function setStatusErr(text) { fileStatus.style.color = "#ff3b30"; fileStatus.textContent = text; }
    function setStatusInfo(text) { fileStatus.style.color = "#8e8e93"; fileStatus.textContent = text; }
    function escapeHtmlText(str) {
      return String(str)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;");
    }
    function escapeHtmlValue(str) {
      return String(str)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }
    function enc(s) { return encodeURIComponent(String(s ?? "")); }
    function dec(s) { return decodeURIComponent(String(s ?? "")); }

    function barcodeLookupUrl(barcode) {
      const b = normalizeBarcode(barcode);
      return "https://barcode-list.ru/barcode/RU/%D0%9F%D0%BE%D0%B8%D1%81%D0%BA.htm?barcode=" + encodeURIComponent(b);
    }
    function openBarcodeLookup(barcode) {
      const url = barcodeLookupUrl(barcode);
      const w = window.open(url, "_blank");
      try { if (w) w.opener = null; } catch (e) {}
    }

    // save-as (folder picker) with fallback
    async function saveWithDialog(blob, suggestedName, mime, ext, description) {
      if (document.activeElement && typeof document.activeElement.blur === "function") {
        document.activeElement.blur(); // –≤–∞–∂–Ω–æ –¥–ª—è –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ blur
      }

      if ("showSaveFilePicker" in window) {
        try {
          const handle = await window.showSaveFilePicker({
            suggestedName,
            types: [{ description, accept: { [mime]: [ext] } }]
          });
          const writable = await handle.createWritable();
          await writable.write(blob);
          await writable.close();
          return;
        } catch (e) {
          if (e && e.name === "AbortError") return; // –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–º–µ–Ω–∏–ª
          console.error("Save picker error:", e);
        }
      }
      saveAs(blob, suggestedName);
    }

    // embedded data
    function tryLoadEmbeddedData() {
      const el = document.getElementById("embeddedData");
      if (!el) return false;
      const txt = (el.textContent || "").trim();
      if (!txt || txt === "{}") return false;
      try {
        const data = JSON.parse(txt);
        if (data && typeof data === "object") {
          synonymsData = data;
          return true;
        }
      } catch (e) {}
      return false;
    }

    // conflicts
    function computeConflicts(data) {
      const conflictGroups = new Set();
      const barcodeToGroups = new Map();

      for (const mainBarcode of Object.keys(data)) {
        const arr = data[mainBarcode];
        const all = [mainBarcode, ...(arr || []).slice(1)];
        for (const bc of all) {
          const b = normalizeBarcode(bc);
          if (!b) continue;
          if (!barcodeToGroups.has(b)) barcodeToGroups.set(b, new Set());
          barcodeToGroups.get(b).add(mainBarcode);
        }
      }

      for (const set of barcodeToGroups.values()) {
        if (set.size > 1) {
          for (const g of set) conflictGroups.add(g);
        }
      }
      return conflictGroups;
    }

    function refreshDerivedState() {
      conflicts = computeConflicts(synonymsData);
      updateUI();
      renderGroups();
    }

    // new group
    function clearNewGroupInputs() {
      newMainBarcodeEl.value = "";
      newGroupNameEl.value = "";
      newSynonymsEl.value = "";
      newGroupNameEl.focus();
    }

    function saveNewGroup() {
      const mainBarcode = normalizeBarcode(newMainBarcodeEl.value);
      const groupName = normalizeName(newGroupNameEl.value);
      const synonymsText = newSynonymsEl.value;

      if (!mainBarcode) { alert("–í–≤–µ–¥–∏—Ç–µ –≥–ª–∞–≤–Ω—ã–π —à—Ç—Ä–∏—Ö–∫–æ–¥"); return; }
      if (synonymsData[mainBarcode]) { alert("–¢–∞–∫–∞—è –≥—Ä—É–ø–ø–∞ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"); return; }

      const synonyms = splitSynonyms(synonymsText);
      synonymsData[mainBarcode] = [groupName, ...synonyms];

      clearNewGroupInputs();
      refreshDerivedState();
    }

    // row operations
    function applyRenameAndName(oldMain, newMain, newName) {
      const oldKey = normalizeBarcode(oldMain);
      const newKey = normalizeBarcode(newMain);

      if (!synonymsData[oldKey]) return null;
      if (!newKey) { alert("–ì–ª–∞–≤–Ω—ã–π —à—Ç—Ä–∏—Ö–∫–æ–¥ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º"); return null; }

      let activeKey = oldKey;

      if (newKey !== oldKey) {
        if (synonymsData[newKey]) { alert("–ì—Ä—É–ø–ø–∞ —Å —Ç–∞–∫–∏–º –≥–ª–∞–≤–Ω—ã–º –®–ö —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"); return null; }
        synonymsData[newKey] = synonymsData[oldKey];
        delete synonymsData[oldKey];
        activeKey = newKey;
      }

      synonymsData[activeKey][0] = normalizeName(newName);
      return activeKey;
    }

    function saveRowFromRowEl(rowEl, oldMain, opts) {
      const nameEl = rowEl.querySelector('input[data-role="name"]');
      const mainEl = rowEl.querySelector('input[data-role="main"]');
      const newSynEl = rowEl.querySelector('input[data-role="newSyn"]');

      const newName = normalizeName(nameEl ? nameEl.value : "");
      const newMain = normalizeBarcode(mainEl ? mainEl.value : oldMain);
      const newSyn = normalizeBarcode(newSynEl ? newSynEl.value : "");

      const activeKey = applyRenameAndName(oldMain, newMain, newName);
      if (!activeKey) return null;

      if (!opts || !opts.skipNewSyn) {
        if (newSyn) {
          const arr = synonymsData[activeKey];
          const existing = new Set(arr.slice(1));
          if (!existing.has(newSyn)) arr.push(newSyn);
          if (newSynEl) newSynEl.value = "";
        }
      }

      return activeKey;
    }

    function deleteGroup(key) {
      const k = normalizeBarcode(key);
      if (!confirm(`–£–¥–∞–ª–∏—Ç—å –≥—Ä—É–ø–ø—É ${k}?`)) return;
      delete synonymsData[k];
      refreshDerivedState();
    }

    function removeSynonym(key, syn) {
      const k = normalizeBarcode(key);
      if (!synonymsData[k]) return;

      const s = normalizeBarcode(syn);
      const arr = synonymsData[k];
      const idx = arr.indexOf(s);

      if (idx >= 1) arr.splice(idx, 1);
      refreshDerivedState();
    }

    // render (sort by name asc always)
    function renderGroups() {
      const keys = Object.keys(synonymsData);

      if (keys.length === 0) {
        groupsContainer.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üìÑ</div>
            <h3>–ü—É—Å—Ç–æ</h3>
            <p>–ó–∞–≥—Ä—É–∑–∏—Ç–µ JSON –∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—É—é –≥—Ä—É–ø–ø—É.</p>
          </div>`;
        return;
      }

      let groups = keys;

      if (searchQuery) {
        groups = groups.filter(mainBarcode => {
          const arr = synonymsData[mainBarcode] || [""];
          const name = String(arr[0] || "").toLowerCase();
          const syns = (arr.slice(1) || []).map(s => String(s).toLowerCase());
          return (
            String(mainBarcode).toLowerCase().includes(searchQuery) ||
            name.includes(searchQuery) ||
            syns.some(s => s.includes(searchQuery))
          );
        });
      }

      groups.sort((a, b) => {
        const nameA = String((synonymsData[a] || [""])[0]).toLowerCase();
        const nameB = String((synonymsData[b] || [""])[0]).toLowerCase();
        if (nameA < nameB) return -1;
        if (nameA > nameB) return 1;
        if (a < b) return -1;
        if (a > b) return 1;
        return 0;
      });

      if (groups.length === 0) {
        groupsContainer.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üîé</div>
            <h3>–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</h3>
            <p>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –∑–∞–ø—Ä–æ—Å –ø–æ–∏—Å–∫–∞.</p>
          </div>`;
        return;
      }

      let html = "";
      for (const mainBarcode of groups) {
        const arr = synonymsData[mainBarcode] || [""];
        const name = arr[0] || "";
        const syns = arr.slice(1) || [];
        const hasConflict = conflicts.has(mainBarcode);
        const safe = safeIdFrom(mainBarcode);

        html += `
          <div class="row ${hasConflict ? "has-conflict" : ""}" id="row-${safe}" data-main="${enc(mainBarcode)}">
            <div class="grid">
              <input class="inp inp-name" type="text" data-role="name" value="${escapeHtmlValue(name)}" placeholder="–ö–∞—Ç–µ–≥–æ—Ä–∏—è (–Ω–∞–∑–≤–∞–Ω–∏–µ)" />

              <div class="main-cell">
                <input class="inp inp-mono" type="text" data-role="main" value="${escapeHtmlValue(mainBarcode)}" placeholder="–ì–ª–∞–≤–Ω—ã–π –®–ö" />
                <a class="loupe-link" href="${escapeHtmlValue(barcodeLookupUrl(mainBarcode))}"
                   target="_blank" rel="noopener"
                   data-action="openLookupMain"
                   title="–û—Ç–∫—Ä—ã—Ç—å –Ω–∞ barcode-list.ru">üîç</a>
              </div>

              <div class="synonyms-cell" title="${escapeHtmlValue(syns.join(", "))}">
                ${syns.map(syn => `
                  <span class="synonym-pill syn-link"
                        role="link"
                        tabindex="0"
                        data-action="openLookupSyn"
                        data-barcode="${enc(syn)}"
                        title="–û—Ç–∫—Ä—ã—Ç—å –Ω–∞ barcode-list.ru">
                    ${escapeHtmlText(syn)}
                    <button class="synonym-remove" type="button"
                      data-action="removeSyn"
                      data-main="${enc(mainBarcode)}"
                      data-syn="${enc(syn)}"
                      title="–£–¥–∞–ª–∏—Ç—å">√ó</button>
                  </span>`).join("")}
              </div>

              <input class="inp inp-mono" type="text" data-role="newSyn" placeholder="–î–æ–±–∞–≤–∏—Ç—å —Å–∏–Ω–æ–Ω–∏–º" />
              <button class="btn btn-success btn-disk" type="button" data-action="saveRow" data-main="${enc(mainBarcode)}" title="–°–æ—Ö—Ä–∞–Ω–∏—Ç—å">üíæ</button>
              <button class="btn btn-danger btn-del" type="button" data-action="deleteGroup" data-main="${enc(mainBarcode)}" title="–£–¥–∞–ª–∏—Ç—å">–£–¥–∞–ª–∏—Ç—å</button>
            </div>
          </div>`;
      }

      groupsContainer.innerHTML = html;
    }

    // delegated events (click)
    groupsContainer.addEventListener("click", (e) => {
      // 1) remove synonym (–≤–∞–∂–Ω–æ: —á—Ç–æ–±—ã –Ω–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–ª–æ –æ—Ç–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–ª–∏–∫—É –Ω–∞ pill)
      const rmBtn = e.target.closest('button[data-action="removeSyn"]');
      if (rmBtn) {
        const main = dec(rmBtn.dataset.main);
        const rowEl = rmBtn.closest(".row");
        if (!rowEl) return;

        const activeKey = saveRowFromRowEl(rowEl, main, { skipNewSyn: true });
        if (!activeKey) return;

        const syn = dec(rmBtn.dataset.syn);
        removeSynonym(activeKey, syn);
        return;
      }

      // 2) save/delete
      const btn = e.target.closest("button[data-action]");
      if (btn) {
        const action = btn.dataset.action;
        const main = dec(btn.dataset.main);
        const rowEl = btn.closest(".row");
        if (!rowEl) return;

        if (action === "saveRow") {
          const activeKey = saveRowFromRowEl(rowEl, main, { skipNewSyn: false });
          if (activeKey) refreshDerivedState();
          return;
        }

        if (action === "deleteGroup") {
          const activeKey = saveRowFromRowEl(rowEl, main, { skipNewSyn: true });
          if (!activeKey) return;
          deleteGroup(activeKey);
          return;
        }
      }

      // 3) open lookup by loupe (main barcode)
      const loupe = e.target.closest('a[data-action="openLookupMain"]');
      if (loupe) {
        e.preventDefault();
        const rowEl = loupe.closest(".row");
        if (!rowEl) return;
        const mainInp = rowEl.querySelector('input[data-role="main"]');
        const bc = normalizeBarcode(mainInp ? mainInp.value : dec(rowEl.dataset.main));
        if (!bc) return;
        openBarcodeLookup(bc);
        return;
      }

      // 4) open lookup by synonym pill click
      const synPill = e.target.closest('[data-action="openLookupSyn"]');
      if (synPill) {
        // –µ—Å–ª–∏ –∫–ª–∏–∫–Ω—É–ª–∏ –ø–æ –∫–Ω–æ–ø–∫–µ —É–¥–∞–ª–µ–Ω–∏—è ‚Äî —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–ª–∏ –≤—ã—à–µ
        const bc = normalizeBarcode(dec(synPill.dataset.barcode));
        if (!bc) return;
        openBarcodeLookup(bc);
        return;
      }
    });

    // open lookup from synonym pill by keyboard
    groupsContainer.addEventListener("keydown", (e) => {
      const synPill = e.target.closest('[data-action="openLookupSyn"]');
      if (synPill && (e.key === "Enter" || e.key === " ")) {
        e.preventDefault();
        const bc = normalizeBarcode(dec(synPill.dataset.barcode));
        if (!bc) return;
        openBarcodeLookup(bc);
        return;
      }

      const inp = e.target.closest('input[data-role="newSyn"]');
      if (!inp) return;
      if (e.key !== "Enter") return;

      e.preventDefault();
      const rowEl = inp.closest(".row");
      if (!rowEl) return;

      const main = dec(rowEl.dataset.main);
      const activeKey = saveRowFromRowEl(rowEl, main, { skipNewSyn: false });
      if (activeKey) refreshDerivedState();
    });

    // AUTOSAVE (name/main/newSyn)
    const autosaveTimers = new WeakMap();
    function debouncePerRow(rowEl, fn, delay) {
      if (!rowEl) return;
      if (autosaveTimers.has(rowEl)) clearTimeout(autosaveTimers.get(rowEl));
      const t = setTimeout(fn, delay);
      autosaveTimers.set(rowEl, t);
    }

    // name: autosave on typing (–±–µ–∑ –ø–µ—Ä–µ—Ä–µ–Ω–¥–µ—Ä–∞, —á—Ç–æ–±—ã –Ω–µ —Å–±–∏–≤–∞—Ç—å –∫—É—Ä—Å–æ—Ä/—Å–æ—Ä—Ç–∏—Ä–æ–≤–∫—É)
    groupsContainer.addEventListener("input", (e) => {
      const nameInp = e.target.closest('input[data-role="name"]');
      if (!nameInp) return;

      const rowEl = nameInp.closest(".row");
      if (!rowEl) return;

      const main = normalizeBarcode(dec(rowEl.dataset.main));
      if (!synonymsData[main]) return;

      debouncePerRow(rowEl, () => {
        if (!synonymsData[main]) return;
        synonymsData[main][0] = normalizeName(nameInp.value);
      }, 250);
    });

    // main barcode: autosave on blur or Enter (—Å –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–æ–π/–ø–µ—Ä–µ—Å—á–µ—Ç–æ–º)
    groupsContainer.addEventListener("keydown", (e) => {
      const mainInp = e.target.closest('input[data-role="main"]');
      if (!mainInp) return;
      if (e.key !== "Enter") return;

      e.preventDefault();
      mainInp.blur(); // blur -> autosave
    });

    // blur handlers (capture)
    groupsContainer.addEventListener("blur", (e) => {
      const mainInp = e.target.closest('input[data-role="main"]');
      if (mainInp) {
        const rowEl = mainInp.closest(".row");
        if (!rowEl) return;

        const oldMain = dec(rowEl.dataset.main);
        const activeKey = saveRowFromRowEl(rowEl, oldMain, { skipNewSyn: true });
        if (activeKey) refreshDerivedState();
        return;
      }

      const newSynInp = e.target.closest('input[data-role="newSyn"]');
      if (newSynInp) {
        const rowEl = newSynInp.closest(".row");
        if (!rowEl) return;

        const v = normalizeBarcode(newSynInp.value);
        if (!v) return;

        const oldMain = dec(rowEl.dataset.main);
        const activeKey = saveRowFromRowEl(rowEl, oldMain, { skipNewSyn: false });
        if (activeKey) refreshDerivedState();
        return;
      }
    }, true);

    // UI
    function updateUI() {
      const hasData = synonymsData && typeof synonymsData === "object" && Object.keys(synonymsData).length > 0;

      searchInput.disabled = !hasData;
      exportJsonBtn.disabled = !hasData;
      exportExcelBtn.disabled = !hasData;
      importExcelBtn.disabled = false;
      exportSelfBtn.disabled = !hasData;
      clearBtn.disabled = !hasData;

      if (!hasData) {
        infoPanel.style.display = "none";
        document.getElementById("groupCount").textContent = "0";
        document.getElementById("synonymCount").textContent = "0";
        document.getElementById("barcodeCount").textContent = "0";
        document.getElementById("conflictCount").textContent = "0";
        return;
      }

      infoPanel.style.display = "grid";

      const groupCount = Object.keys(synonymsData).length;
      let synonymCount = 0;
      const allBarcodes = new Set();

      for (const mainBarcode of Object.keys(synonymsData)) {
        allBarcodes.add(mainBarcode);
        const a = synonymsData[mainBarcode] || [""];
        const s = a.slice(1) || [];
        synonymCount += s.length;
        for (const x of s) allBarcodes.add(x);
      }

      document.getElementById("groupCount").textContent = String(groupCount);
      document.getElementById("synonymCount").textContent = String(synonymCount);
      document.getElementById("barcodeCount").textContent = String(allBarcodes.size);
      document.getElementById("conflictCount").textContent = String(conflicts.size);
    }

    // export JSON
    async function exportJson() {
      const json = JSON.stringify(synonymsData, null, 2);
      const blob = new Blob([json], { type: "application/json;charset=utf-8" });

      const now = new Date();
      const yyyy = now.getFullYear();
      const mm = String(now.getMonth() + 1).padStart(2, "0");
      const dd = String(now.getDate()).padStart(2, "0");

      await saveWithDialog(
        blob,
        `synonyms-${yyyy}-${mm}-${dd}.json`,
        "application/json",
        ".json",
        "JSON"
      );
    }

    // export Excel
    async function exportExcel() {
      const workbook = new ExcelJS.Workbook();
      const worksheet = workbook.addWorksheet("Synonyms");

      worksheet.addRow(["–ì–ª–∞–≤–Ω—ã–π –®–ö", "–ö–∞—Ç–µ–≥–æ—Ä–∏—è", "–°–∏–Ω–æ–Ω–∏–º—ã"]);
      Object.keys(synonymsData).forEach(mainBarcode => {
        const arr = synonymsData[mainBarcode] || [""];
        const name = arr[0] || "";
        const syns = (arr.slice(1) || []).join(", ");
        worksheet.addRow([mainBarcode, name, syns]);
      });

      worksheet.columns.forEach((column, idx) => {
        if (idx === 0) column.width = 22;
        else if (idx === 1) column.width = 40;
        else column.width = 60;
      });

      const headerRow = worksheet.getRow(1);
      headerRow.font = { bold: true };
      headerRow.fill = { type: "pattern", pattern: "solid", fgColor: { argb: "FFE0E0E0" } };

      worksheet.eachRow(row => {
        row.eachCell(cell => {
          cell.border = {
            top: { style: "thin" },
            left: { style: "thin" },
            bottom: { style: "thin" },
            right: { style: "thin" }
          };
        });
      });

      const buffer = await workbook.xlsx.writeBuffer();
      const blob = new Blob([buffer], {
        type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
      });

      const now = new Date();
      const yyyy = now.getFullYear();
      const mm = String(now.getMonth() + 1).padStart(2, "0");
      const dd = String(now.getDate()).padStart(2, "0");

      await saveWithDialog(
        blob,
        `synonyms-${yyyy}-${mm}-${dd}.xlsx`,
        "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
        ".xlsx",
        "Excel"
      );
    }

    // import Excel
    function handleExcelImport(e) {
      const file = e.target.files?.[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (event) => {
        try {
          const data = new Uint8Array(event.target.result);
          const workbook = XLSX.read(data, { type: "array" });
          const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
          const rows = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });

          if (!rows || rows.length < 2) {
            alert("Excel –ø—É—Å—Ç–æ–π –∏–ª–∏ –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –¥–∞–Ω–Ω—ã—Ö.");
            return;
          }

          rows.slice(1).forEach(row => {
            const mainBarcode = normalizeBarcode(row?.[0]);
            const name = normalizeName(row?.[1]);
            const synonymsRaw = String(row?.[2] ?? "").trim();
            if (!mainBarcode) return;

            const syns = synonymsRaw ? synonymsRaw.split(",").map(s => s.trim()).filter(Boolean) : [];

            if (!synonymsData[mainBarcode]) {
              synonymsData[mainBarcode] = [name, ...syns];
              return;
            }

            const arr = synonymsData[mainBarcode];
            if (name) arr[0] = name;

            const existing = new Set(arr.slice(1));
            syns.forEach(s => {
              if (!existing.has(s)) {
                arr.push(s);
                existing.add(s);
              }
            });
          });

          alert("–ò–º–ø–æ—Ä—Ç Excel –∑–∞–≤–µ—Ä—à—ë–Ω.");
          refreshDerivedState();
        } catch (err) {
          console.error("–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ Excel:", err);
          alert("–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ Excel. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞.");
        } finally {
          excelImportInput.value = "";
        }
      };

      reader.onerror = () => {
        alert("–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è Excel-—Ñ–∞–π–ª–∞.");
        excelImportInput.value = "";
      };

      reader.readAsArrayBuffer(file);
    }

    // self-save HTML
    async function exportSelfHtml() {
      if (!synonymsData || Object.keys(synonymsData).length === 0) {
        alert("–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è.");
        return;
      }

      const el = document.getElementById("embeddedData");
      if (!el) {
        alert("–ù–µ –Ω–∞–π–¥–µ–Ω –±–ª–æ–∫ embeddedData.");
        return;
      }

      const json = JSON.stringify(synonymsData, null, 2).replace(/<\/script/gi, "<\\/script");
      el.textContent = json;

      const html = "<!DOCTYPE html>\n" + document.documentElement.outerHTML;
      const blob = new Blob([html], { type: "text/html;charset=utf-8" });

      await saveWithDialog(
        blob,
        "sinonims2.html",
        "text/html",
        ".html",
        "HTML"
      );
    }

    // clear
    function clearAll() {
      if (!confirm("–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë?")) return;
      synonymsData = {};
      conflicts = new Set();
      searchQuery = "";
      fileInput.value = "";
      excelImportInput.value = "";
      searchInput.value = "";
      setStatusInfo("–§–∞–π–ª –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω");
      clearNewGroupInputs();
      refreshDerivedState();
    }

    // wiring
    fileInput.addEventListener("change", (e) => {
      const file = e.target.files?.[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (event) => {
        try {
          const json = JSON.parse(event.target.result);
          if (!json || typeof json !== "object") throw new Error("JSON invalid");

          synonymsData = json;
          searchQuery = (searchInput.value || "").toLowerCase().trim();
          setStatusOk(file.name);
          refreshDerivedState();
        } catch (err) {
          console.error("–û—à–∏–±–∫–∞ JSON:", err);
          setStatusErr("–û—à–∏–±–∫–∞ JSON");
          alert("–û—à–∏–±–∫–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ JSON-—Ñ–∞–π–ª.");
        }
      };

      reader.onerror = () => {
        setStatusErr("–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è");
        alert("–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞.");
      };

      reader.readAsText(file, "utf-8");
    });

    searchInput.addEventListener("input", (e) => {
      searchQuery = (e.target.value || "").toLowerCase().trim();
      renderGroups();
    });

    exportJsonBtn.addEventListener("click", exportJson);
    exportExcelBtn.addEventListener("click", exportExcel);
    importExcelBtn.addEventListener("click", () => excelImportInput.click());
    excelImportInput.addEventListener("change", handleExcelImport);
    exportSelfBtn.addEventListener("click", exportSelfHtml);
    clearBtn.addEventListener("click", clearAll);

    createGroupBtn.addEventListener("click", saveNewGroup);
    clearNewGroupBtn.addEventListener("click", clearNewGroupInputs);

    [newGroupNameEl, newMainBarcodeEl, newSynonymsEl].forEach(el => {
      el.addEventListener("keypress", (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          saveNewGroup();
        }
      });
    });

    // init
    function init() {
      const loaded = tryLoadEmbeddedData();
      if (loaded) setStatusOk("–ó–∞–≥—Ä—É–∂–µ–Ω–æ –∏–∑ HTML");
      else setStatusInfo("–§–∞–π–ª –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω");
      refreshDerivedState();
    }
    init();
  </script>
  <script>
(function(){
  const href = location.href;
  document.querySelectorAll('.global-nav__link').forEach(a => {
    const m = a.getAttribute('data-match') || '';
    if (m && href.includes(m)) a.classList.add('is-active');
    // –∑–∞–ø–∞—Å–Ω–æ–π –≤–∞—Ä–∏–∞–Ω—Ç: –µ—Å–ª–∏ —Å–æ–≤–ø–∞–¥–∞–µ—Ç –¥–æ–º+–ø—É—Ç—å —Ü–µ–ª–∏–∫–æ–º
    if (!m && href.startsWith(a.href)) a.classList.add('is-active');
  });
})();
</script>

</body>
</html>
